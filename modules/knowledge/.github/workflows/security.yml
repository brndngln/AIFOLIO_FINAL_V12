# AIFOLIO Elite Security Scanning Pipeline
# Phase 1.11 - Advanced Security Integration
# Comprehensive vulnerability detection and compliance validation

name: ğŸ”’ Security Fortress Scanner

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Security Scan Type'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - dependencies
        - secrets
        - code-analysis

env:
  NODE_VERSION: '18.17.0'
  PYTHON_VERSION: '3.11'

jobs:
  # ğŸ•µï¸ Secret Detection & Credential Scanning
  secret-detection:
    name: ğŸ•µï¸ Secret & Credential Scanner
    runs-on: ubuntu-latest
    if: ${{ !inputs.scan_type || inputs.scan_type == 'full' || inputs.scan_type == 'secrets' }}
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: ğŸ” GitLeaks Secret Detection
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: ğŸ” TruffleHog Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: ğŸ“Š Upload Secret Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-scan-results-${{ github.sha }}
          path: |
            gitleaks-report.json
            trufflehog-results.json
          retention-days: 30

  # ğŸ›¡ï¸ Dependency Vulnerability Scanning
  dependency-scan:
    name: ğŸ›¡ï¸ Dependency Vulnerability Scanner
    runs-on: ubuntu-latest
    if: ${{ !inputs.scan_type || inputs.scan_type == 'full' || inputs.scan_type == 'dependencies' }}
    timeout-minutes: 15

    strategy:
      matrix:
        ecosystem: [python, nodejs]

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Python Dependency Scanning
        if: matrix.ecosystem == 'python'
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit

          # Safety scan
          safety check --json --output safety-report.json || true

          # Pip-audit scan
          pip-audit --format=json --output=pip-audit-report.json || true

      - name: ğŸ“¦ Node.js Dependency Scanning
        if: matrix.ecosystem == 'nodejs'
        working-directory: ./config
        run: |
          # NPM audit
          npm audit --audit-level=low --json > npm-audit-report.json || true

          # Yarn audit (if yarn.lock exists)
          if [ -f "yarn.lock" ]; then
            yarn audit --json > yarn-audit-report.json || true
          fi

      - name: ğŸ” Snyk Vulnerability Scanning
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --json-file-output=snyk-report.json

      - name: ğŸ“Š Upload Dependency Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-scan-${{ matrix.ecosystem }}-${{ github.sha }}
          path: |
            safety-report.json
            pip-audit-report.json
            config/npm-audit-report.json
            config/yarn-audit-report.json
            snyk-report.json
          retention-days: 30

  # ğŸ”¬ Static Code Analysis
  code-analysis:
    name: ğŸ”¬ Static Code Analysis
    runs-on: ubuntu-latest
    if: ${{ !inputs.scan_type || inputs.scan_type == 'full' || inputs.scan_type == 'code-analysis' }}
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: ğŸ Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ” Python Security Analysis (Bandit)
        run: |
          pip install bandit[toml]
          bandit -r . -f json -o bandit-security-report.json || true
          bandit -r . -f txt -o bandit-security-report.txt || true

      - name: ğŸ” Python Code Quality (Pylint)
        run: |
          pip install pylint
          pylint --output-format=json --reports=y --exit-zero . > pylint-report.json || true

      - name: ğŸ” JavaScript/TypeScript Analysis (ESLint)
        working-directory: ./config
        run: |
          npm ci --prefer-offline --no-audit
          npx eslint . --ext .js,.jsx,.ts,.tsx --format json --output-file eslint-report.json || true

      - name: ğŸ” SonarCloud Analysis
        uses: SonarSource/sonarcloud-github-action@master
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: ğŸ” CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python

      - name: ğŸ” CodeQL Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ” CodeQL Analysis Results
        uses: github/codeql-action/analyze@v3

      - name: ğŸ“Š Upload Code Analysis Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-analysis-results-${{ github.sha }}
          path: |
            bandit-security-report.json
            bandit-security-report.txt
            pylint-report.json
            config/eslint-report.json
          retention-days: 30

  # ğŸ° Container Security Scanning
  container-scan:
    name: ğŸ° Container Security Scanner
    runs-on: ubuntu-latest
    if: ${{ !inputs.scan_type || inputs.scan_type == 'full' }}
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ³ Build Docker Image
        run: |
          # Create a minimal Dockerfile for scanning
          cat > Dockerfile << 'EOF'
          FROM node:18.17.0-alpine
          WORKDIR /app
          COPY config/package*.json ./
          RUN npm ci --only=production
          COPY . .
          EXPOSE 3000
          CMD ["npm", "start"]
          EOF

          docker build -t aifolio-security-scan:latest .

      - name: ğŸ” Trivy Container Scanning
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'aifolio-security-scan:latest'
          format: 'json'
          output: 'trivy-container-report.json'

      - name: ğŸ” Grype Container Scanning
        uses: anchore/scan-action@v3
        with:
          image: 'aifolio-security-scan:latest'
          format: 'json'
          output-file: 'grype-container-report.json'

      - name: ğŸ“Š Upload Container Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-scan-results-${{ github.sha }}
          path: |
            trivy-container-report.json
            grype-container-report.json
          retention-days: 30

  # ğŸ“‹ Security Report Aggregation
  security-report:
    name: ğŸ“‹ Security Report Aggregation
    runs-on: ubuntu-latest
    needs: [secret-detection, dependency-scan, code-analysis, container-scan]
    if: always()
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Download All Scan Results
        uses: actions/download-artifact@v4
        with:
          path: security-reports/

      - name: ğŸ“Š Generate Security Summary
        run: |
          echo "# ğŸ”’ AIFOLIO Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Scan Date:** $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-summary.md
          echo "" >> security-summary.md

          echo "## ğŸ“Š Scan Results Overview" >> security-summary.md
          echo "" >> security-summary.md
          echo "| Scanner | Status | Files Scanned |" >> security-summary.md
          echo "|---------|--------|---------------|" >> security-summary.md

          # Process scan results
          find security-reports/ -name "*.json" -type f | while read file; do
            scanner=$(basename $(dirname "$file"))
            echo "| $scanner | âœ… Complete | $(wc -l < "$file") |" >> security-summary.md
          done

          echo "" >> security-summary.md
          echo "## ğŸ›¡ï¸ Security Status" >> security-summary.md
          echo "" >> security-summary.md

          if [ "${{ needs.secret-detection.result }}" = "success" ]; then
            echo "- ğŸ•µï¸ **Secret Detection:** âœ… PASSED" >> security-summary.md
          else
            echo "- ğŸ•µï¸ **Secret Detection:** âŒ FAILED" >> security-summary.md
          fi

          if [ "${{ needs.dependency-scan.result }}" = "success" ]; then
            echo "- ğŸ›¡ï¸ **Dependency Scan:** âœ… PASSED" >> security-summary.md
          else
            echo "- ğŸ›¡ï¸ **Dependency Scan:** âŒ FAILED" >> security-summary.md
          fi

          if [ "${{ needs.code-analysis.result }}" = "success" ]; then
            echo "- ğŸ”¬ **Code Analysis:** âœ… PASSED" >> security-summary.md
          else
            echo "- ğŸ”¬ **Code Analysis:** âŒ FAILED" >> security-summary.md
          fi

          if [ "${{ needs.container-scan.result }}" = "success" ]; then
            echo "- ğŸ° **Container Scan:** âœ… PASSED" >> security-summary.md
          else
            echo "- ğŸ° **Container Scan:** âŒ FAILED" >> security-summary.md
          fi

          echo "" >> security-summary.md
          echo "---" >> security-summary.md
          echo "*Generated by AIFOLIO Elite Security Pipeline*" >> security-summary.md

      - name: ğŸ“Š Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary-${{ github.sha }}
          path: |
            security-summary.md
            security-reports/
          retention-days: 90

      - name: ğŸ“¢ Security Scan Notification
        if: always()
        run: |
          echo "ğŸ”’ AIFOLIO Security Scan Complete!"
          echo "ğŸ“Š Results uploaded to artifacts"
          echo "ğŸ” Review security-summary.md for detailed findings"

          # Check for critical failures
          if [ "${{ needs.secret-detection.result }}" = "failure" ] ||
             [ "${{ needs.dependency-scan.result }}" = "failure" ] ||
             [ "${{ needs.code-analysis.result }}" = "failure" ] ||
             [ "${{ needs.container-scan.result }}" = "failure" ]; then
            echo "ğŸš¨ CRITICAL: Security scan failures detected!"
            echo "ğŸ”’ Review findings before deployment"
          else
            echo "âœ… All security scans passed successfully"
          fi
