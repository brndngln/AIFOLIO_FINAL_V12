{% extends 'dashboard.html' %} {% block content %}
<h2>Product Analytics</h2>
<table>
  <tr>
    <th>Metric</th>
    <th>Value</th>
  </tr>
  <tr>
    <td>Sales</td>
    <td>{{ analytics.sales }}</td>
  </tr>
  <tr>
    <td colspan="2">
      <!doctype html>
      <html lang="en">
        <head>
          <meta charset="UTF-8" />
          <title>AIFOLIO™ Analytics Dashboard</title>
          <link rel="stylesheet" href="/static/dashboard.css" />
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <script src="/static/analytics.js"></script>
        </head>
        <body>
          <header role="banner">
            <h1>AIFOLIO™ Analytics Dashboard</h1>
            <nav role="navigation" aria-label="Main Navigation">
              <a href="/dashboard">Dashboard</a>
              <a href="/compliance">Compliance</a>
              <a href="/documentation">Documentation</a>
              <a href="/legal_export">Legal Export</a>
            </nav>
            <label for="themeSelect" style="float: right; margin: 0 1rem"
              >Theme:
              <select id="themeSelect">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
                <option value="high-contrast">High Contrast</option>
              </select>
            </label>
          </header>
          <main id="main-content" role="main" tabindex="-1">
            <section aria-labelledby="analytics-filters">
              <h2 id="analytics-filters">Analytics Filters</h2>
              <form
                id="analyticsFilterForm"
                aria-label="Analytics Filter Form"
                style="
                  margin-bottom: 1rem;
                  display: flex;
                  flex-wrap: wrap;
                  gap: 1rem;
                  align-items: center;
                "
              >
                <label for="date_from"
                  >From: <input type="date" id="date_from" name="date_from"
                /></label>
                <label for="date_to"
                  >To: <input type="date" id="date_to" name="date_to"
                /></label>
                <label for="event_type"
                  >Event Type:
                  <select id="event_type" name="event_type">
                    <option value="">All</option>
                    <option value="compliance">Compliance</option>
                    <option value="reviewer">Reviewer</option>
                    <option value="payment">Payment</option>
                    <option value="audit">Audit</option>
                  </select>
                </label>
                <label for="reviewer"
                  >Reviewer:
                  <input
                    type="text"
                    id="reviewer"
                    name="reviewer"
                    placeholder="Reviewer name or ID"
                /></label>
                <button type="submit" aria-label="Apply Analytics Filters">
                  Apply Filters
                </button>
              </form>
            </section>
            <section aria-labelledby="trend-title">
              <h2 id="trend-title">Compliance & Analytics Trends</h2>
              <canvas
                id="trendChart"
                width="600"
                height="250"
                aria-label="Compliance Trends Line Chart"
                role="img"
              ></canvas>
              <form
                action="/api/analytics/export/csv"
                method="get"
                id="analyticsExportCsv"
                style="display: inline"
              >
                <input type="hidden" name="date_from" />
                <input type="hidden" name="date_to" />
                <input type="hidden" name="event_type" />
                <input type="hidden" name="reviewer" />
                <button type="submit" aria-label="Export Analytics as CSV">
                  Export CSV
                </button>
              </form>
              <form
                action="/api/analytics/export/pdf"
                method="get"
                id="analyticsExportPdf"
                style="display: inline"
              >
                <input type="hidden" name="date_from" />
                <input type="hidden" name="date_to" />
                <input type="hidden" name="event_type" />
                <input type="hidden" name="reviewer" />
                <button type="submit" aria-label="Export Analytics as PDF">
                  Export PDF
                </button>
              </form>
            </section>
            <div
              id="inAppNotifications"
              aria-live="polite"
              style="
                margin: 1rem 0;
                padding: 0.5rem;
                background: #333;
                color: #fff;
                border-radius: 6px;
                display: none;
              "
            ></div>
            <section aria-labelledby="risk-title">
              <h2 id="risk-title">Compliance Risk Heatmap</h2>
              <div
                id="complianceAlerts"
                aria-live="assertive"
                style="color: #e74c3c; font-weight: bold; margin-bottom: 1rem"
              ></div>
              <canvas
                id="riskHeatmap"
                width="600"
                height="300"
                aria-label="Compliance Risk Heatmap"
                role="img"
              ></canvas>
            </section>
            <section aria-labelledby="reviewer-analytics">
              <h2 id="reviewer-analytics">Reviewer Analytics & Escalations</h2>
              <canvas
                id="reviewerStatsChart"
                width="600"
                height="250"
                aria-label="Reviewer Activity Chart"
                role="img"
              ></canvas>
              <table
                id="reviewerStatsTable"
                style="margin-top: 1rem; width: 100%; border-collapse: collapse"
              >
                <thead>
                  <tr>
                    <th>Reviewer</th>
                    <th>Events</th>
                    <th>Last Activity</th>
                    <th>Avg Response Time (s)</th>
                    <th>Accuracy Rate (%)</th>
                    <th>Total Reviews</th>
                    <th>Escalation Rate (%)</th>
                    <th>Escalations</th>
                    <th>Escalate</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <div id="escalationList" style="margin-top: 1rem"></div>
              <div
                id="escalationForm"
                style="
                  display: none;
                  margin-top: 1rem;
                  background: #222b28;
                  padding: 1rem;
                  border-radius: 8px;
                "
              >
                <h3>Escalate Reviewer</h3>
                <form id="escalateReviewerForm">
                  <input type="hidden" name="reviewer" id="escalateReviewer" />
                  <label for="escalationReason">Reason:</label>
                  <input
                    type="text"
                    name="reason"
                    id="escalationReason"
                    required
                    style="width: 60%"
                  />
                  <button type="submit">Submit Escalation</button>
                  <button type="button" id="cancelEscalation">Cancel</button>
                </form>
                <div id="escalationStatus" style="margin-top: 0.5rem"></div>
              </div>
            </section>
            <section aria-labelledby="notification-settings">
              <h2 id="notification-settings">Notification Settings</h2>
              <form
                id="notificationSettingsForm"
                style="display: flex; gap: 1rem; align-items: center"
              >
                <label
                  ><input type="checkbox" id="notifInApp" /> In-App
                  Notifications</label
                >
                <label
                  ><input type="checkbox" id="notifEmail" /> Email
                  Notifications</label
                >
                <button type="submit">Save Preferences</button>
                <span
                  id="notifSettingsSaved"
                  style="margin-left: 1rem; color: #b0d36a; display: none"
                  >Saved!</span
                >
              </form>
              <div id="notifSettingsStatus" style="margin-top: 0.5rem"></div>
            </section>
            <section aria-labelledby="audit-search">
              <h2 id="audit-search">Advanced Audit Search</h2>
              <form
                id="auditSearchForm"
                style="
                  display: flex;
                  gap: 1rem;
                  align-items: center;
                  flex-wrap: wrap;
                "
              >
                <input
                  type="text"
                  id="auditQuery"
                  placeholder="Search audit trail (user, action, IP, etc)"
                  style="width: 25rem"
                />
                <label for="auditDateFrom"
                  >From: <input type="date" id="auditDateFrom"
                /></label>
                <label for="auditDateTo"
                  >To: <input type="date" id="auditDateTo"
                /></label>
                <label for="auditActionType"
                  >Action Type:
                  <select id="auditActionType">
                    <option value="">All</option>
                    <option value="export">Export</option>
                    <option value="escalation">Escalation</option>
                    <option value="download">Download</option>
                    <option value="delete">Delete</option>
                  </select>
                </label>
                <button type="submit">Search</button>
              </form>
              <div
                id="auditLoading"
                style="margin-top: 0.5rem; display: none; color: #b0d36a"
              >
                Loading...
              </div>
              <table
                id="auditResultsTable"
                style="
                  margin-top: 1rem;
                  width: 100%;
                  border-collapse: collapse;
                  display: none;
                "
              >
                <thead>
                  <tr>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>IP</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <div
                id="auditEmptyState"
                style="margin-top: 0.5rem; display: none; color: #e74c3c"
              >
                No results found.
              </div>
            </section>
            <section aria-labelledby="legal-title">
              <h2 id="legal-title">Legal Export & Summaries</h2>
              <form
                action="/legal_export/pdf_bundle"
                method="get"
                style="display: inline"
              >
                <button type="submit" aria-label="Export Legal PDF Bundle">
                  Export Legal PDF Bundle
                </button>
              </form>
              <form
                action="/legal_export/summary"
                method="get"
                style="display: inline"
              >
                <button type="submit" aria-label="Export Legal Summary">
                  Export Legal Summary
                </button>
              </form>
              <form
                action="/legal_export/jurisdiction"
                method="get"
                style="display: inline"
              >
                <button
                  type="submit"
                  aria-label="Export Jurisdictional Breakdown"
                >
                  Export Jurisdictional Breakdown
                </button>
              </form>
              <form
                action="/legal_export/template"
                method="get"
                style="display: inline"
              >
                <label for="legal_template"
                  >Template:
                  <select id="legal_template" name="template">
                    <option value="summary">Summary</option>
                    <option value="gdpr">GDPR Statement</option>
                    <option value="ccpa">CCPA Statement</option>
                    <option value="hipaa">HIPAA Statement</option>
                    <option value="custom">Custom</option>
                  </select>
                </label>
                <button type="submit" aria-label="Export Legal Template">
                  Export Template
                </button>
              </form>
              <div
                id="legalDocPreview"
                aria-live="polite"
                style="margin-top: 1rem"
              ></div>
              <!-- Custom Legal Template Editing/Upload -->
              <form
                id="customLegalForm"
                action="/legal_export/custom"
                method="post"
                enctype="multipart/form-data"
                style="
                  margin-top: 1rem;
                  background: #222b28;
                  padding: 1rem;
                  border-radius: 8px;
                "
              >
                <label for="customLegalText">Edit Custom Template:</label><br />
                <textarea
                  id="customLegalText"
                  name="customLegalText"
                  rows="6"
                  cols="70"
                  placeholder="Enter or edit your custom legal statement here..."
                ></textarea
                ><br />
                <label for="customLegalFile">Upload Template (.txt):</label>
                <input
                  type="file"
                  id="customLegalFile"
                  name="customLegalFile"
                  accept=".txt"
                /><br />
                <button type="submit" aria-label="Save/Upload Custom Template">
                  Save/Upload Custom Template
                </button>
              </form>
              <div
                id="customLegalStatus"
                aria-live="polite"
                style="margin-top: 0.5rem; color: #b0d36a"
              ></div>
              <div id="customLegalList" style="margin-top: 1rem"></div>
            </section>
            <script>
              // Advanced analytics filtering and chart update logic
              document
                .getElementById("analyticsFilterForm")
                .addEventListener("submit", function (e) {
                  e.preventDefault();
                  const date_from = this.date_from.value;
                  const date_to = this.date_to.value;
                  const event_type = this.event_type.value;
                  const reviewer = this.reviewer.value;
                  window.fetchAndRender(
                    "/api/analytics/trends?date_from=" +
                      date_from +
                      "&date_to=" +
                      date_to +
                      "&event_type=" +
                      event_type +
                      "&reviewer=" +
                      reviewer,
                    window.renderTrends,
                  );
                  window.fetchAndRender(
                    "/api/analytics/risk_heatmap?date_from=" +
                      date_from +
                      "&date_to=" +
                      date_to +
                      "&event_type=" +
                      event_type +
                      "&reviewer=" +
                      reviewer,
                    window.renderRiskHeatmap,
                  );
                  // Set export form hidden values
                  for (const formId of [
                    "analyticsExportCsv",
                    "analyticsExportPdf",
                  ]) {
                    const form = document.getElementById(formId);
                    form.date_from.value = date_from;
                    form.date_to.value = date_to;
                    form.event_type.value = event_type;
                    form.reviewer.value = reviewer;
                  }
                });
              // Legal template preview (mockup)
              document
                .getElementById("legal_template")
                .addEventListener("change", function () {
                  let txt = "";
                  switch (this.value) {
                    case "summary":
                      txt = "Executive summary of compliance and legal status.";
                      break;
                    case "gdpr":
                      txt =
                        "GDPR Compliance Statement: All EU user data protected.";
                      break;
                    case "ccpa":
                      txt =
                        "CCPA Compliance Statement: California privacy rights enforced.";
                      break;
                    case "hipaa":
                      txt =
                        "HIPAA Compliance Statement: Health data protected.";
                      break;
                    case "custom":
                      txt = "Custom legal statement: [edit as needed]";
                      break;
                  }
                  document.getElementById("legalDocPreview").textContent = txt;
                });
            </script>
          </main>
        </body>
      </html>
    </td>
  </tr>
  <tr>
    <td>Conversion Rate</td>
    <td>{{ analytics.conversion }}%</td>
  </tr>
</table>
<h3>Performance Suggestions</h3>
<ul>
  {% for suggestion in analytics.suggestions %}
  <li>{{ suggestion }}</li>
  {% endfor %}
</ul>
<a href="/dashboard">Back</a>
{% endblock %}
